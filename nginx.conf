server {
  listen       8080;
  server_name  _;

  root   /usr/share/nginx/html;
  index  index.html;

  # Prevent nginx from including port in redirects; rely on Fly headers
  port_in_redirect off;
  server_name_in_redirect off;

  # Health check endpoint
  location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
  }

  # Cache HTML modestly
  location ~* \.(?:html)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # Cache static assets aggressively
  location ~* \.(?:css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000";
    add_header Vary "Accept-Encoding";
  }

  location ~* \.(?:png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000";
  }

  location ~* \.(?:woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000";
    add_header Access-Control-Allow-Origin "*";
  }

  # Cache JSON and XML
  location ~* \.(?:json|xml)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # Specific content types
  location = /robots.txt { add_header Content-Type text/plain; }
  location = /sitemap.xml { add_header Content-Type application/xml; }

  # HTTPS redirect based on Fly's proxy header
  if ($http_x_forwarded_proto = "http") { return 301 https://$http_host$request_uri; }

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # Default: serve files with SPA-style fallbacks
  location / {
    try_files $uri $uri.html $uri/index.html /index.html;
  }
}


